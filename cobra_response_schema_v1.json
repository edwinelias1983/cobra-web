{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://cobra.example/schema/cobra-response-v7.json",
  "title": "COBRA Response Schema V7",
  "type": "object",
  "additionalProperties": true,
  "$comment": "ADD-ONLY CHANGE: comments added for rolling-chat compatibility. Validation semantics unchanged.",

  "required": [
    "domain",
    "phase",
    "intent",
    "text",
    "micro_check",
    "repair_required",
    "stability_assessment"
  ],

  "properties": {
    "domain": {
      "type": "string",
      "enum": [
        "D0",
        "D0B",
        "D1",
        "D2",
        "D2B",
        "D3",
        "D3B",
        "D4",
        "D5"
      ]
    },

    "phase": {
      "type": "string",
      "enum": [
        "PHASE_1",
        "PHASE_2"
      ],
      "$comment": "UI NOTE: Your index.html expects PHASE_1/PHASE_2 elsewhere; this schema currently enforces PHASE1/PHASE_2."
    },

    "intent": {
      "type": "string",
      "enum": [
        "QUESTION",
        "EXPLANATION",
        "MICRO_CHECK",
        "REPAIR",
        "TRANSFER_CHECK",
        "STRESS_TEST",
        "EXPANSION_INVITE",
        "SUMMARY"
      ]
    },

    "text": {
      "type": "string",
      "minLength": 1,
      "$comment": "Rolling chat: text is required canonical output even when segments are present."
    },

    "advance_allowed": {
      "type": "boolean",
      "default": false,
      "$comment": "Informational UI hint; server must enforce gating regardless of this flag."
    },

    "symbols_used": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "minItems": 0
    },

    "introduced_new_symbols": {
      "type": "boolean"
    },

    "new_symbols_proposed": {
      "type": "array",
      "items": {
        "type": "string",
        "minLength": 1
      },
      "default": []
    },

    "media_suggestions": {
      "type": "array",
      "default": [],
      "items": {
        "type": "object",
        "additionalProperties": true,
        "required": [
          "type",
          "search_query",
          "symbol_reference"
        ],
        "properties": {
          "type": {
            "type": "string",
            "enum": [
              "gif",
              "image"
            ]
          },
          "search_query": {
            "type": "string",
            "minLength": 1
          },
          "symbol_reference": {
            "type": "string",
            "minLength": 1
          },
          "provider_hint": {
            "type": "string",
            "enum": [
              "giphy",
              "tenor",
              "unsplash",
              "pexels",
              "google",
              "other"
            ],
            "default": "other"
          }
        }
      }
    },

    "micro_check": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "prompt",
        "expected_response_type"
      ],
      "properties": {
        "prompt": {
          "type": "string",
          "minLength": 1
        },
        "expected_response_type": {
          "type": "string",
          "enum": [
            "conceptual",
            "symbolic",
            "metaphoric",
            "analogy",
            "pattern",
            "temporal",
            "systemic",
            "paradox"
          ]
        }
      }
    },

    "repair_required": {
      "type": "boolean"
    },

    "diagnostic_mapping": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "original_text",
        "missing_elements"
      ],
      "properties": {
        "original_text": {
          "type": "string",
          "minLength": 1
        },
        "missing_elements": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    },

    "stability_assessment": {
      "type": "string",
      "enum": [
        "STABLE",
        "UNSTABLE",
        "UNKNOWN"
      ]
    },

    "next_domain_recommendation": {
      "type": "string",
      "enum": [
        "D0",
        "D0B",
        "D1",
        "D2",
        "D2B",
        "D3",
        "D3B",
        "D4",
        "D5"
      ]
    },

    "notes_for_orchestrator": {
      "type": "string",
      "default": ""
    },

    "symbol_universe": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "User-approved symbolic universe tokens (from Domain 0). Required for D1 and D2."
    },

    "interaction_mode": {
      "type": "string",
      "enum": [
        "learn",
        "adventure",
        "mastery"
      ]
    },

    "current_domain": {
      "type": "string"
    },

    "stamina_gate_available": {
      "type": "boolean"
    },

    "consolidation_active": {
      "type": "boolean"
    },

    "symbolic_universe": {
      "type": "object",
      "additionalProperties": true
    },

    "auditory_universe": {
      "type": "object",
      "additionalProperties": true
    },

    "state": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "domain0_complete",
        "domain0b_complete"
      ],
      "properties": {
        "domain0_complete": {
          "type": "boolean"
        },
        "domain0b_complete": {
          "type": "boolean"
        }
      }
    }
  },

  "allOf": [
    {
      "if": {
        "properties": {
          "domain": { "enum": ["D1", "D2"] }
        }
      },
      "then": {
        "required": ["symbol_universe"],
        "properties": {
          "symbol_universe": {
            "minItems": 1
          }
        }
      }
    },
    {
      "if": {
        "properties": {
          "intent": { "const": "REPAIR" }
        }
      },
      "then": {
        "required": ["diagnostic_mapping"]
      }
    }